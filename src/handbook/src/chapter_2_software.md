# Управление программным обеспечением

---

**TODO**

- [ ] Зависимости
- [x] Установка по
- [x] Удаление по
- [ ] Обновление по
- [ ] Обновление системы портов
- [x] Просмотр информации о ПО
- [ ] Список портов

---

Всё программное обеспечение в Calmira GNU/Linux-libre собирается из исходного
кода. Для многих людей это достаточно сложный и утомительный процесс, поэтому в
системе присутствует средство для автоматизации этого процесса: система портов и
программа, которая с ней взаимодействует.

> Эта вещь называется "системой портов" потому, что она может функционировать на
> различных архитектурах процессора.

## Система портов

Система портов представляет собой набор файлов в `/usr/ports`. В этой директории
существует ряд поддиректорий, которые являются категориями ПО, сортирующее это
ПО по предназначению. К примеру, поддиректория `base/` содержит в себе все
системные порты, поддиректория `editors/` содержит в себе порты текстовых
редакторов.

В категориях расположены ещё одни поддиректории - это либо каталоги с самими
портами (имя каталога = имя порта), либо подкатегории. Например, подкатегория
`base/efi` содержит в себе порты для обеспечения корректной загрузки системы на
UEFI.

**Как различать каталог с портом от каталога с подкатегорией портов?** Очень
просто. В подкатегориях содержатся ещё одни каталоги, в которых расположены
порты, принадлежащие данной подкатегориию. В директории порта же находятся
текстовые файлы, основные из них: `install`, `port.toml` и `files.list`. Об их
предназначении далее.

### Строение порта

#### Нахождение порта в файловой системе

Порт - это директория в одной из (под)категорий в `/usr/ports`. Когда мы
называем имя порта, мы указываем его по следующему примеру: **`категория/имя`**.
Т.е. указываем путь до директории порта, опуская `/usr/ports`. Например, порт,
находящийся по адресу `/usr/ports/base/acl` в руководстве и прочей документации
будет указываться как `base/acl`. Тоже самое нужно указывать и при работе с
менеджером системы портов cport, речь о котором будет в следующей части этой
страницы.

#### Файлы в каталоге порта

Порт - это набор определённых файлов, содержащих сведения о портируемом ПО,
инструкции по сборке этого ПО из исходного кода и список файлов, которые этот
порт устанавливает в систему:

- `port.toml` - информация о портируемом ПО. Содержит сведения об имени пакета,
  его версии, краткое описание, информация о сборщике данного порта, список
  зависимостей и прочие подобные сведения.
- `install` - исполняемый BASH-скрипт, содержащий инструкции по сборке ПО из
  исходного кода.
- `files.list` - список файлов, которые будут установлены в систему этим портом.

Кроме того, есть ряд необязательных файлов:

- `README.md` - Markdown-файл, содержащий сведения из файла `port.toml`.
  Предназначен для формирования этой документации.
- `files/` - директория, содержащая дополнительные файлы порта, такие, как
  сторонние рекомендуемые конфигурационные файлы или патчи.
- `description` - файл с расширенным описанием порта (т.к. описание в
  `port.toml` ограничено 1й строкой, файл `description` может содержать
  произвольный объём информации).

> **Обратите внимание!**
>
> Глава 2 является вводной, поэтому здесь не будет расширенных сведений о
> системе портов и управлении программным обеспечением. Для получения
> дополнительных сведений см. [главу 3](./chapter_3_software.md).

## Менеджер системы портов `cport`

cport предназначен для управления системой портов. Без него СП - просто набор
ненужных никому файлов. cport же выполняет основные действия по работе с СП:
чтение конфигурационного файла порта, скачивание и распаковка архивов с исходным
кодом, исполнение сборочных инструкций порта и ведение локальной базы данных
установленного в систему ПО.

Без cport пользователю самостоятельно приходилось бы собирать и хранить сведения
об установленном в систему программном обеспечении, самостоятельно скачивать и
распаковывать архив с исходниками ПО, а также запускать сборочные инструкции ПО.
Данный метод не является безопасным, а cport выполняет множество проверок портов
и дистрибутива перед исполнением каких-либо действий.

Иначе говоря, cport автоматизирует рутинные действия пользователей и
администраторов, к тому же, избавляя их от выполнения проверок и тестов на
совместимость с дистрибутивом Calmira GNU/Linux-libre, например.

### Возможности `cport`

- Установка ПО
- Удаление ПО
- Сбор, хранение и просмотр информации о ПО
- Ведение локальной базы данных установленного в систему ПО
- Обслуживание системы портов (проверка на ошибки, поддержание её в актуальном
  состоянии)
- Обновление ПО до новой версии
- etc.

### Установка программного обеспечения

Для того, чтобы установить какой-либо порт, используется ключ `-i` (полная
версия: `--install`):

```
# cport -i PORT_NAME
```

<small>Вместо <tt><code>PORT_NAME</code></tt> подставьте имя нужного порта,
например, <tt><code>base/acl</code></tt>. Кроме того, вы можете указать
несколько портов. Они будут собраны в указанной вами последовательности.</small>

> **Обратите внимание!**
>
> cport не обрабатывает зависимости! Поэтому, если у программы есть зависимости,
> их вам нужно установить первыми, а уже потом собрать исходный порт.

### Удаление программного обеспечения

Для удаления используется ключ `-r` (`--remove`):

```
# cport -r PORT_NAME
```

МСП пройдётся по файлу `files.list` порта. Каждый файл, который указанный порт
устанавливает в систему, указывается на новой строке `files.list`. На основе
содержимого этого файла cport составляет список файлов. После чего проходится по
этому списку и удаляет из него те файлы, которые в системе отсутствуют. По
завершению этого процесса все существующие в системе файлы удаляются.

### Просмотр информации о ПО

Для того, чтобы просмотреть информацию о порте(ах) используется ключ `-I`
(`--info`):

```
# cport -I PORT_NAME
```

Будет прочитано содержимое файла `port.toml` указанного порта, после чего
результат парсинга будет выведен на экран:

```
====================== Information about port 'base/attr' ======================
Base information:
name        : attr
version     : 2.5.1
description : Commands for Manipulating Filesystem Extended Attributes.
maintainer  : Sergey Gaberer <nordic.dev@pm.me>
releases    : v2.0a1 v2.0a2 v2.0a3
priority    : system
usage       : 4.4
upgrade_mode: soft
build_time  : 0.1
installed   : True

Dependencies:
required    : base/libtool


```

В терминал будет выведена основная информация, взятая из файла `port.toml`:

- **name** - имя **программы** (а не порта - имя порта и так уже известно)
- **version** - версия порта/программы
- **description** - краткое описание порта
- **maintainer** - информация о создателе и/или сопровождающем порта
- **releases** - список релизов Calmira GNU/Linux-libre, с которыми совместим
  данный порт
- **priority** - приоритет порта (`system` - системный, `user` -
  пользовательский; системные порты нельзя удалять из системы во избежание
  ошибок в её работе)
- **usage** - сколько занимает место порт в файловой системе после установки (в
  мегабайтах)
- **upgrade_mode** - режим обновления (`soft` - порт просто переустанавливается,
  `hard` - все файлы порта удаляются, после чего устанавливается новая версия
  порта)
- **build_time** - примерное время сборки порта (в единицах, аналогичных SBU из
  руководства "Linux From Scratch")
- **installed** - установлен ли порт в систему (`True` - порт установлен,
  `False` - порт не установлен)

Далее идёт секция с описанием зависимостей порта:

- **required** - необходимые зависимости
- **recommend** - рекомендуемые зависимости
- **optional** - опциональные зависимости

> **Обратите внимание!**
>
> Какого-то из пункта с описанием типов зависимостей в выводе может и не быть
> (ровным счётом как и у ПО может не быть определённого типа зависимостей).
> Иногда возникают такие ситуации, когда секция `Dependencies` вообще пуста -
> ничего страшного или необычного в этом нет.
